<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>属性value管理</title>
    <script type="text/javascript" src="../common/lib/jquery-3.2.1.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            refresh();
        });

        function refresh() {
            var appCode = getUrlParam("appCode");
            var profileCode = getUrlParam("profileCode");
            refreshProperties(appCode, profileCode, false)
            if (appCode != "common") {
                $("#commonPropertiesDiv").show();
                refreshProperties("common", profileCode, true)
            } else {
                $("#commonPropertiesDiv").hide();
            }
        }

        function refreshProperties(appCode, profileCode, isCommonProperties) {
            var keyInfos = getPropertyKeyInfos(appCode);
            var valueInfos = getPropertyValueInfo(appCode, profileCode);
            var propertyMap = getPropertyMap(keyInfos, valueInfos);
            createTable(propertyMap, isCommonProperties)
        }

        function getPropertyKeyInfos(appCode) {
            var keyInfos;
            $.ajax({
                url: "/manage/propertyKey/findAppPropertyKey",
                data: {
                    appCode: appCode
                },
                async: false,
                success: function (ajaxResult) {
                    if (!ajaxResult.success || ajaxResult.infos == null) {
                        alert("查询失败，原因：" + ajaxResult.message);
                    } else {
                        keyInfos = ajaxResult.infos;
                    }
                },
                error: function () {
                    alert("请求服务失败");
                }
            });
            return keyInfos;
        }

        function getPropertyValueInfo(appCode, profileCode) {
            var valueInfos;
            $.ajax({
                url: "/manage/propertyValue/findAppProfilePropertyValue",
                data: {
                    appCode: appCode,
                    profileCode: profileCode
                },
                async: false,
                success: function (ajaxResult) {
                    if (!ajaxResult.success || ajaxResult.infos == null) {
                        alert("查询失败，原因：" + ajaxResult.message);
                    } else {
                        valueInfos = ajaxResult.infos;
                    }
                },
                error: function () {
                    alert("请求服务失败");
                }
            });
            return valueInfos;
        }

        function getPropertyMap(keyInfos, valueInfos) {
            var propertyMap = new Array();
            for (var i = 0; i < keyInfos.length; i++) {
                var property = new Array();
                property["key"] = keyInfos[i].key;
                property["common"] = keyInfos[i].common;
                property["memo"] = keyInfos[i].memo;
                property["value"] = "";

                propertyMap[keyInfos[i].key] = property;
            }
            for (var i = 0; i < valueInfos.length; i++) {
                var property = propertyMap[valueInfos[i].key];
                property["value"] = valueInfos[i].value;
            }

            return propertyMap;
        }

        function createTable(infos, isCommonProperties) {
            var table = "<table border=\"1\">";
            table += createTableHead(isCommonProperties);
            for (var key in infos) {
                table += creteTableRow(infos[key], isCommonProperties);
            }
            table += "</table>";
            if (isCommonProperties) {
                $("#commonTableDiv").html(table);
            } else {
                $("#appTableDiv").html(table);
            }
        }

        function createTableHead(isCommonProperties) {
            var tr = "<tr>";
            tr += "<th>属性key</th>"
            if (!isCommonProperties) {
                tr += "<th>是否公用</th>"
            }
            tr += "<th>备注</th>"
            tr += "<th>属性value</th>"
            if (!isCommonProperties) {
                tr += "<th>操作</th>"
            }
            tr += "</tr>"

            return tr;
        }

        function creteTableRow(info, isCommonProperties) {
            var tr = "<tr>";
            tr += "<td>" + info["key"] + "</td>";
            if (!isCommonProperties) {
                tr += "<td>" + info["common"] + "</td>";
            }
            tr += "<td>" + info["memo"] + "</td>";
            tr += "<td>" + info["value"] + "</td>";
            if (!isCommonProperties) {
                tr += "<td><button onclick='deleteEntity(\"" + info["key"] + "\")'>置空</button></td>"
            }
            tr += "</tr>"

            return tr;
        }

        function deleteEntity(key) {
            $.ajax({
                url: "../manage/propertyValue/deletePropertyValue",
                data: {
                    appCode: getUrlParam("appCode"),
                    key: key,
                    profileCode: getUrlParam("profileCode")
                },
                success: function (ajaxResult) {
                    if (ajaxResult.success) {
                        refresh();
                    } else {
                        alert("删除失败，原因：" + ajaxResult.description);
                    }
                }
            });
        }

        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)return unescape(r[2]);
            return null;
        }

        function addOrModifyPropertyKey() {
            var form = $("#addOrModifyPropertyKeyForm");
            $.ajax({
                url: "../manage/propertyKey/addOrModifyPropertyKey",
                data: form.serialize() + "&appCode=" + getUrlParam("appCode"),
                success: function (ajaxResult) {
                    if (ajaxResult.success) {
                        refresh();
                    } else {
                        alert("失败，原因：" + ajaxResult.description);
                    }
                },
                error: function () {
                    alert("请求服务失败");
                }
            });
        }

        function setPropertyValue() {
            var form = $("#setPropertyValueForm");
            $.ajax({
                url: "../manage/propertyValue/setPropertyValue",
                data: form.serialize() + "&appCode=" + getUrlParam("appCode") + "&profileCode=" + getUrlParam("profileCode"),
                success: function (ajaxResult) {
                    if (ajaxResult.success) {
                        refresh();
                    } else {
                        alert("失败，原因：" + ajaxResult.description);
                    }
                },
                error: function () {
                    alert("请求服务失败");
                }
            });
        }

    </script>
</head>
<body>
<table>
    <tr>
        <td>
            <div>
                <table>
                    <tr>
                        <td>新增或修改属性key:</td>
                    </tr>
                    <tr>
                        <td>
                            <form id="addOrModifyPropertyKeyForm" action="../manage/propertyKey/addOrModifyPropertyKey">
                                <table>
                                    <tr>
                                        <td align="right">key：</td>
                                        <td><input type="text" name="key"></td>
                                    </tr>
                                    <tr>
                                        <td align="right">是否公用：</td>
                                        <td><input type="text" name="common"></td>
                                    </tr>
                                    <tr>
                                        <td align="right">备注：</td>
                                        <td><input type="text" name="memo"></td>
                                    </tr>
                                    <tr>
                                        <td align="right"><input type="button" onclick="addOrModifyPropertyKey()"
                                                                 value="提交"></td>
                                        <td></td>
                                    </tr>
                                </table>
                            </form>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
        <td width="100px"></td>
        <td valign="top">
            <div>
                <table>
                    <tr>
                        <td>设置属性value:</td>
                    </tr>
                    <tr>
                        <td>
                            <form id="setPropertyValueForm" action="../manage/propertyValue/setPropertyValue">
                                <table>
                                    <tr>
                                        <td align="right">key：</td>
                                        <td><input type="text" name="key"></td>
                                    </tr>
                                    <tr>
                                        <td align="right">value：</td>
                                        <td><input type="text" name="value"></td>
                                    </tr>
                                    <tr>
                                        <td align="right"><input type="button" onclick="setPropertyValue()" value="提交">
                                        </td>
                                        <td></td>
                                    </tr>
                                </table>
                            </form>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
    </tr>
</table>
<br>
<br>
自定义配置：
<div id="appTableDiv"></div>
<br><br>
<div id="commonPropertiesDiv">
    公共配置：
    <div id="commonTableDiv"></div>
</div>
</body>
</html>